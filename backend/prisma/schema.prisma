// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  ADMIN
  DIRECTOR
  HR
  FINANCE
  HEAD_OF_DEPARTMENT
  EMPLOYEE
}

enum AvailabilityStatus {
  AVAILABLE
  ON_LEAVE
  ON_MISSION
  UNAVAILABLE
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum MissionStatus {
  DRAFT
  PENDING_ASSIGNMENT
  ASSIGNED
  IN_APPROVAL
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  DECLINED
  SUBSTITUTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubstitutionReason {
  MEDICAL
  FAMILY_EMERGENCY
  CONFLICT_OF_INTEREST
  OTHER
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
}

// Core Models

model User {
  id                 String             @id @default(uuid()) @db.Uuid
  employeeId         String             @unique
  email              String             @unique
  password           String
  firstName          String
  lastName           String
  phone              String?
  role               Role               @default(EMPLOYEE)
  position           String?
  profilePhoto       String?
  availabilityStatus AvailabilityStatus @default(AVAILABLE)
  accountStatus      AccountStatus      @default(ACTIVE)
  lastLogin          DateTime?

  // Relations
  department   Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  departmentId String?     @db.Uuid

  departmentLed Department? @relation("DepartmentHead")

  skills               EmployeeSkill[]
  missionsCreated      Mission[]             @relation("MissionCreator")
  assignments          MissionAssignment[]
  substitutionRequests SubstitutionRequest[]
  approvals            MissionApproval[]
  missionReports       MissionReport[]
  auditLogs            AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([departmentId])
  @@index([role])
}

model Department {
  id               String  @id @default(uuid()) @db.Uuid
  name             String  @unique
  code             String  @unique
  description      String?
  budgetAllocation Decimal @default(0) @db.Decimal(15, 2)
  status           String  @default("ACTIVE")

  // Relations
  users          User[]    @relation("DepartmentEmployees")
  missions       Mission[]
  departmentHead User?     @relation("DepartmentHead", fields: [headId], references: [id])
  headId         String?   @unique @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

model EmployeeSkill {
  id        String @id @default(uuid()) @db.Uuid
  skillName String

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid

  createdAt DateTime @default(now())

  @@index([userId])
}

model MissionType {
  id                     String   @id @default(uuid()) @db.Uuid
  name                   String   @unique // Formation, Inspection, Livraison, etc.
  description            String?
  defaultBudgetMin       Decimal? @db.Decimal(15, 2)
  defaultBudgetMax       Decimal? @db.Decimal(15, 2)
  requiredQualifications String[] // Array of required skills
  status                 String   @default("ACTIVE")

  // Relations
  missions Mission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Mission {
  id                     String        @id @default(uuid()) @db.Uuid
  missionNumber          String        @unique // Auto-generated
  title                  String
  description            String
  destination            String
  startDate              DateTime
  endDate                DateTime
  urgencyLevel           UrgencyLevel  @default(MEDIUM)
  estimatedBudget        Decimal       @db.Decimal(15, 2)
  budgetCode             String?
  requiredQualifications String[] // Array of required skills
  status                 MissionStatus @default(DRAFT)

  // Relations
  missionType   MissionType @relation(fields: [missionTypeId], references: [id])
  missionTypeId String      @db.Uuid

  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String     @db.Uuid

  createdBy   User   @relation("MissionCreator", fields: [createdById], references: [id])
  createdById String @db.Uuid

  assignments MissionAssignment[]
  approvals   MissionApproval[]
  reports     MissionReport[]
  expenses    ExpenseItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([missionNumber])
  @@index([status])
  @@index([departmentId])
  @@index([startDate])
}

model MissionAssignment {
  id                        String           @id @default(uuid()) @db.Uuid
  assignmentReason          String // Auto-generated explanation
  fairnessScoreAtAssignment Decimal          @db.Decimal(5, 2)
  assignmentStatus          AssignmentStatus @default(PENDING)
  responseNotes             String?
  isSubstitution            Boolean          @default(false)

  // Relations
  mission   Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  missionId String  @db.Uuid

  employee   User   @relation(fields: [employeeId], references: [id])
  employeeId String @db.Uuid

  originalAssignment      MissionAssignment?  @relation("Substitution", fields: [originalAssignmentId], references: [id])
  originalAssignmentId    String?             @db.Uuid
  substitutionAssignments MissionAssignment[] @relation("Substitution")

  substitutionRequest SubstitutionRequest?

  assignedAt  DateTime  @default(now())
  respondedAt DateTime?
  updatedAt   DateTime  @updatedAt

  @@index([missionId])
  @@index([employeeId])
  @@index([assignmentStatus])
}

model SubstitutionRequest {
  id                  String             @id @default(uuid()) @db.Uuid
  reasonCategory      SubstitutionReason
  detailedReason      String
  supportingDocuments String[] // File paths
  status              ApprovalStatus     @default(PENDING)
  reviewerComments    String?
  reviewedAt          DateTime?

  // Relations
  assignment   MissionAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  assignmentId String            @unique @db.Uuid

  employee   User   @relation(fields: [employeeId], references: [id])
  employeeId String @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([employeeId])
}

model MissionApproval {
  id            String         @id @default(uuid()) @db.Uuid
  approvalStage Int // 1, 2, 3, 4 (Dept Head, Finance, HR, Director)
  approverRole  Role
  status        ApprovalStatus @default(PENDING)
  comments      String?

  // Relations
  mission   Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  missionId String  @db.Uuid

  approver   User?   @relation(fields: [approverId], references: [id])
  approverId String? @db.Uuid

  approvedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([missionId])
  @@index([approvalStage])
  @@index([status])
}

model MissionReport {
  id               String    @id @default(uuid()) @db.Uuid
  activityReport   String // Text of what was accomplished
  status           String    @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  reviewerComments String?
  reviewedAt       DateTime?

  // Relations
  mission   Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  missionId String  @db.Uuid

  employee   User   @relation(fields: [employeeId], references: [id])
  employeeId String @db.Uuid

  expenses ExpenseItem[]

  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([missionId])
  @@index([employeeId])
}

model ExpenseItem {
  id              String   @id @default(uuid()) @db.Uuid
  category        String // transport, accommodation, per_diem, meals, other
  description     String
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @default("BIF")
  receiptFilePath String?
  transactionDate DateTime
  isApproved      Boolean  @default(false)

  // Relations
  mission   Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  missionId String  @db.Uuid

  report   MissionReport? @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId String?        @db.Uuid

  createdAt DateTime @default(now())

  @@index([missionId])
  @@index([reportId])
}

// System Configuration & Settings

model SystemSetting {
  id           String  @id @default(uuid()) @db.Uuid
  settingKey   String  @unique
  settingValue String
  category     String // general, missions, approvals, budget, notifications, security
  description  String?

  updatedAt DateTime @updatedAt
}

model PerDiemRate {
  id              String    @id @default(uuid()) @db.Uuid
  destinationType String // local, provincial, international
  destinationName String
  dailyRate       Decimal   @db.Decimal(15, 2)
  currency        String    @default("BIF")
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([destinationName])
}

// Audit & Security

model AuditLog {
  id          String  @id @default(uuid()) @db.Uuid
  action      String // create, update, delete, login, logout, approve, reject
  module      String // users, missions, approvals, settings
  tableName   String?
  recordId    String?
  beforeValue String? // JSON string
  afterValue  String? // JSON string
  ipAddress   String?
  userAgent   String?

  // Relations
  user   User?   @relation(fields: [userId], references: [id])
  userId String? @db.Uuid

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([createdAt])
}
